# Tag My Video - 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名

Tag My Video

### 1.2 目的

スポーツ映像（特にラグビー）を分析するためのビデオタグ付けアプリケーション。映像の特定の瞬間にイベントをタグ付けし、統計分析を行うことで、戦術分析やパフォーマンス向上を支援する。

### 1.3 対象ユーザー

- スポーツアナリスト
- コーチ・監督
- 選手
- ビデオ分析担当者

## 2. 機能要件

### 2.1 映像再生機能

#### 2.1.1 デュアル映像再生

- **要件**: 最大2つの映像ファイルを同時に再生できる
- **詳細**:
  - タイトビュー（寄り）とワイドビュー（引き）の同期再生
  - MP4、MOV形式の映像ファイルをサポート
  - 映像はサイドバイサイドで表示

#### 2.1.1.1 音声同期機能（改善版）

- **要件**: 複数の映像ファイルの音声波形を分析して自動同期
- **詳細**:
  - パッケージ作成時に自動的に音声同期分析を実行
  - ファイル名ベースの同期ヒント検出（寄り・引きカメラの識別）
  - 同期オフセットの自動検出と適用
  - 同期信頼度スコア（0-100%）の算出と色分け表示
  - 分析中のプログレス表示
  - 同期失敗時のフォールバック機能
- **操作機能**:
  - メニューバーからの同期再実行（Cmd+Shift+S）
  - 同期リセット機能（Cmd+Shift+R）
  - 手動オフセット調整機能（Cmd+Shift+O）
  - UIボタンからの同期操作

#### 2.1.1.2 共通シークバー機能（新機能）

- **要件**: 複数映像を統一的に制御する共通シークバー
- **詳細**:
  - 1つのスライダーで全映像を同時制御
  - 同期オフセットを考慮した時刻調整
  - 同期状態の視覚的表示（オフセット値・信頼度）
  - リアルタイムでの同期維持機能

#### 2.1.2 映像制御

- **再生/停止機能**:
  - UI上のボタンによる操作
  - キーボードショートカット（上キー）による操作
- **再生速度変更機能**:
  - 0.5倍速（右キー）
  - 1倍速（デフォルト）
  - 2倍速（Shift + 右キー）
  - 4倍速（Command + 右キー）
  - 6倍速（Option + 右キー）
- **映像シーク機能**:
  - 5秒戻し（左キー）
  - 10秒戻し（Shift + 左キー）
  - スライダーによる任意の位置へのジャンプ

### 2.2 イベントタグ付け機能

#### 2.2.1 リアルタイムタグ付け

- **要件**: 映像再生中にボタン操作でイベントをタグ付けできる
- **詳細**:
  - 1回目ボタン押下: イベント開始時刻を記録（ボタンがアクティブ状態に変化）
  - 2回目ボタン押下: イベント終了時刻を記録（タイムラインデータが生成される）

#### 2.2.2 対応イベント（アクション）

- **基本アクション**:
  - ポゼッション
  - スクラム
  - ラインアウト
  - キック
  - タックル
  - PK（ペナルティキック）
  - FK（フリーキック）
  - Check
  - キックオフ
  - トライ
  - ショット

#### 2.2.3 チーム別タグ付け

- **要件**: 各アクションにチーム情報を関連付ける
- **詳細**:
  - 設定可能な2チーム名
  - チーム別にボタンの色分け（チーム1: 赤、チーム2: 青）

### 2.3 タイムライン管理機能

#### 2.3.1 タイムラインデータ構造

```typescript
TimelineData = {
  id: string;           // ユニークID（ULID）
  actionName: string;   // アクション名（チーム名 + アクション種別）
  startTime: number;    // 開始時刻（秒）
  endTime: number;      // 終了時刻（秒）
  actionResult: string; // アクション結果
  actionType: string;   // アクション種別
  qualifier: string;    // 追加情報・修飾子
}
```

#### 2.3.2 タイムライン表示・編集

- **テーブル表示**: 全イベントを時系列で表示
- **ソート機能**: アクション名、開始時刻、終了時刻でソート可能
- **インライン編集**:
  - アクション結果の選択（ドロップダウン）
  - アクション種別の選択（ドロップダウン）
  - 修飾子の自由入力
- **映像ジャンプ**: 開始時刻・終了時刻ボタンクリックで該当映像位置にジャンプ
- **複数選択削除**: チェックボックスによる複数イベントの一括削除

#### 2.3.3 データ永続化

- **ファイル形式**: JSON形式
- **保存場所**: パッケージディレクトリ内の`timeline.json`
- **自動保存**: 明示的な保存ボタン操作による

### 2.4 パッケージ管理機能

#### 2.4.1 パッケージ構造

```
PackageName/
├── .metadata/
│   └── config.json      # チーム名、アクションリスト設定
├── timeline.json        # タイムラインデータ
└── videos/
    ├── PackageName 寄り.mp4   # タイトビュー映像
    └── PackageName 引き.mp4   # ワイドビュー映像（オプション）
```

#### 2.4.2 パッケージ作成

- **新規パッケージ作成**:
  - パッケージ名入力
  - チーム名設定（2チーム）
  - 映像ファイル選択（寄り、引き）
  - 自動的なファイル整理・リネーム

#### 2.4.3 パッケージ読み込み

- **既存パッケージ選択**: ディレクトリ選択による一括読み込み
- **設定復元**: チーム名、アクションリスト、タイムラインデータの自動復元

### 2.5 統計分析・可視化機能

#### 2.5.1 統計表示

- **ポゼッション分析**:
  - チーム別ポゼッション時間の円グラフ表示
  - 時間フォーマット（MM:SS）での表示
- **アクション分析**:
  - チーム別、アクション別の結果統計
  - アクション種別の分布統計
  - 円グラフによる視覚化

#### 2.5.2 モメンタムチャート

- **要件**: ポゼッションの流れを視覚化
- **表示内容**:
  - ポゼッション時間の棒グラフ
  - チーム別の色分け
  - 結果による色分け（Try、Positive、Negative）

#### 2.5.3 表示制御

- **モーダル表示**: Command + Shift + A によるモーダル表示
- **スクロール対応**: 統計情報の縦スクロール表示

## 3. 非機能要件

### 3.1 パフォーマンス

- **映像再生**: スムーズな再生、同期再生の精度維持
- **レスポンス**: タグ付け操作に対する即座の反応（100ms以内）
- **大容量ファイル**: 長時間映像ファイルの安定した処理

### 3.2 ユーザビリティ

- **直感的操作**: スポーツ分析の専門知識を持つユーザーが迷わず操作できる
- **キーボードショートカット**: 映像を見ながらの効率的な操作
- **視認性**: 映像とコントロールパネルの適切な配置

### 3.3 信頼性

- **データ保護**: タイムラインデータの確実な保存
- **エラーハンドリング**: ファイル読み込みエラー、映像再生エラーの適切な処理
- **バックアップ**: 意図しないデータ削除の防止

### 3.4 拡張性

- **アクション追加**: 新しいスポーツや分析項目への対応
- **フォーマット拡張**: 新しい映像フォーマットのサポート
- **エクスポート機能**: 他システムとの連携を見据えた拡張

## 4. 制約事項

### 4.1 技術制約

- **プラットフォーム**: macOS優先（dmgファイルでの配布）
- **映像フォーマット**: MP4、MOV形式のみサポート
- **同時映像数**: 最大2つまで

### 4.2 業務制約

- **対象スポーツ**: 主にラグビー（アクションリストが特化）
- **言語**: 日本語UI
- **利用環境**: デスクトップ環境での利用を想定

## 5. 今後の拡張予定

### 5.1 機能拡張

- **映像同期機能**: 異なる開始時刻の映像の同期調整
- **エクスポート機能**: CSV、Excel形式でのデータエクスポート
- **プリセット管理**: よく使用するタグ付けパターンの保存・呼び出し

### 5.2 分析機能拡張

- **時系列分析**: 試合の流れの詳細分析
- **ヒートマップ**: アクション発生位置の可視化
- **比較分析**: 複数試合間の比較機能

### 5.3 UI/UX改善

- **レスポンシブ対応**: ウィンドウサイズに応じた最適表示 ✅ 実装済み
  - ビデオプレイヤー高さの可変対応 (xs: 40vh, sm: 50vh, md: 55vh, lg: 60vh)
  - タイムラインテーブルとコードパネルの画面サイズ別配置 (xs: 全幅, lg: 7:5分割)
  - 最小高さ・最大高さの設定による視認性確保
- **テーマ機能**: ダーク/ライトテーマの切替
- **多言語対応**: 英語UI対応

## 6. 実装済み改善 (2025年10月実施)

### 6.1 パッケージ作成UX改善

- **段階的入力フロー**: 4ステップのウィザード形式
  1. 基本情報入力 (パッケージ名、チーム名)
  2. 保存先選択
  3. 映像ファイル選択 (寄り必須、引き任意)
  4. 作成内容確認
- **入力バリデーション**: リアルタイムエラー表示
- **視覚的フィードバック**: 選択済みファイルの明確な表示、進捗インジケーター
- **操作性向上**: 前後のステップ移動、キャンセル機能

### 6.2 デザインシステム導入

- **統一カラーパレット**:
  - team1: 赤系統 (#d32f2f)
  - team2: 青系統 (#1976d2)
  - momentum: Try (#ff5722), Positive (#4caf50), Negative (#9c27b0), Neutral (#757575)
- **タイポグラフィ**: Hiragino, Yu Gothic対応
- **スペーシング**: 8px基準の統一
- **角丸**: デフォルト8pxの統一感

### 6.3 キーボードショートカット可視化

- **ショートカットガイドコンポーネント**:
  - ビデオコントローラーにアイコンボタン配置
  - モーダルでカテゴリ別一覧表示
  - 再生制御、音声同期、統計・分析の3カテゴリ
- **ユーザビリティ向上**: 新規ユーザーの機能発見を支援

### 6.4 エラーハンドリング強化

- **統一エラーステート**: useVideoPlayerAppフックで一元管理
- **エラータイプ分類**: file, network, sync, playback, general
- **Snackbar通知**: 6秒自動非表示、エラー種別による色分け
- **ユーザーフレンドリー**: 分かりやすいエラーメッセージ

### 6.5 タイムライン検索・フィルタリング強化

- **複合検索機能**:
  - テキスト検索: アクション名、修飾子、結果、種別の横断検索
  - チーム別フィルタ: ドロップダウンで特定チームのみ表示
  - アクション種別フィルタ: 種別による絞り込み
- **リアルタイム件数表示**: フィルタ適用後の件数と全件数の表示
- **UIの洗練**: Select, TextField, InputAdornmentの組み合わせ
