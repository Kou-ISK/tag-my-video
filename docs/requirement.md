# Tag My Video - 技術仕様書

---

## 1. プロジェクト概要

### 1.1 目的

スポーツ映像（特にラグビー）を分析するためのビデオタグ付けアプリケーション。映像の特定の瞬間にイベントをタグ付けし、統計分析を行うことで、戦術分析やパフォーマンス向上を支援する。

### 1.2 対象ユーザー

- スポーツアナリスト
- コーチ・監督
- 選手
- ビデオ分析担当者

### 1.3 技術スタック

| カテゴリ               | 技術          | バージョン |
| ---------------------- | ------------- | ---------- |
| フロントエンド         | React         | 18.3.1     |
| 言語                   | TypeScript    | 5.9.3      |
| デスクトップ           | Electron      | 31.7.7     |
| UI                     | Material-UI   | 5.18.0     |
| ビデオ                 | Video.js      | 8.23.4     |
| パッケージマネージャー | pnpm          | 9.1.0+     |
| ビルドツール           | react-scripts | 5.0.1      |

---

## 2. 機能要件

### 2.1 映像再生機能

#### 2.1.1 デュアル映像同期再生

- **要件**: 最大2つの映像ファイルを同時に同期再生
- **対応フォーマット**: MP4、MOV
- **推奨コーデック**: H.264/AVC、AAC音声
- **表示レイアウト**: サイドバイサイド（左右並列）

#### 2.1.2 音声同期機能

**自動同期**:

- 音声波形の相互相関分析による自動オフセット検出
- FFT（高速フーリエ変換）を用いた特徴量計算
- ファイル名ベースのカメラ種別ヒント検出（寄り/引き、tight/wide）
- 同期信頼度スコア（0-100%）の算出と色分け表示
- 分析プログレスバーの表示

**手動調整**:

- 手動オフセット調整ダイアログ（`Cmd+Shift+O`）
- 同期リセット機能（`Cmd+Shift+R`）
- 同期再実行（`Cmd+Shift+S`）

**データ保存**:

- パッケージ内の `.metadata/sync.json` に保存
- オフセット値、信頼度、分析日時を記録

#### 2.1.3 共通シークバー

- 1つのスライダーで複数映像を同時制御
- 同期オフセットを考慮した時刻調整
- 同期状態の視覚的表示（オフセット値・信頼度）
- NaN防止の多層防護（型チェック、範囲検証）

#### 2.1.4 映像制御

**再生/停止**:

- UIボタン、`↑`キー

**再生速度**:

- 0.5倍速: `→`キー
- 1.0倍速: デフォルト
- 2.0倍速: `Shift + →`
- 4.0倍速: `Cmd + →`
- 6.0倍速: `Option + →`

**シーク**:

- 5秒戻し: `←`キー
- 10秒戻し: `Shift + ←`
- スライダーによる任意位置ジャンプ

### 2.2 イベントタグ付け機能

#### 2.2.1 リアルタイムタグ付け

- **1回目ボタン押下**: イベント開始時刻を記録（ボタンがアクティブ状態に変化）
- **2回目ボタン押下**: イベント終了時刻を記録（タイムラインデータ生成）
- **自動保存**: 明示的な保存ボタン操作による

#### 2.2.2 対応アクション（ラグビー）

| アクション   | 主な結果                            | 主な種別                                  |
| ------------ | ----------------------------------- | ----------------------------------------- |
| ポゼッション | Try, Drop Goal, Pen Won, Turnover   | Kick Return, Turnover Won, Lineout, Scrum |
| スクラム     | Won Outright, Won PK, Lost Outright | Positive, Neutral, Negative               |
| ラインアウト | Won, Won & Maul, Lost               | Front, Middle, Back                       |
| キック       | Touch(Bounce), Touch(Full), Error   | Bomb, Chip, Territorial, Box              |
| PK           | Not Releasing, Offside, Foul Play   | Offence, Defence                          |
| トライ       | Conversion Success/Missed           | BK, FW                                    |
| ショット     | Success, Missed                     | -                                         |
| チェック     | Good, Bad                           | Offence, Defence                          |

詳細は `src/ActionList.ts` 参照。

#### 2.2.3 チーム別タグ付け

- 2チーム設定可能
- チーム別ボタン色分け（チーム1: 赤系統、チーム2: 青系統）
- アクション名に自動的にチーム名を付加

### 2.3 タイムライン管理機能

#### 2.3.1 データ構造

```typescript
TimelineData = {
  id: string;           // ユニークID（ULID）
  actionName: string;   // アクション名（チーム名 + アクション種別）
  startTime: number;    // 開始時刻（秒）
  endTime: number;      // 終了時刻（秒）
  actionResult: string; // アクション結果
  actionType: string;   // アクション種別
  qualifier: string;    // 追加情報・修飾子
}
```

#### 2.3.2 表示・編集機能

- **テーブル表示**: 時系列での一覧表示
- **ソート**: アクション名、開始時刻、終了時刻でソート可能
- **インライン編集**:
  - アクション結果: ドロップダウン選択
  - アクション種別: ドロップダウン選択
  - 修飾子: テキスト入力
- **映像ジャンプ**: 開始/終了時刻ボタンで該当位置に移動
- **複数選択削除**: チェックボックス + 削除ボタン

#### 2.3.3 検索・フィルタリング

- **テキスト検索**: アクション名、修飾子、結果、種別の横断検索
- **チーム別フィルタ**: ドロップダウンで特定チームのみ表示
- **アクション種別フィルタ**: 種別による絞り込み
- **リアルタイム件数表示**: フィルタ適用後の件数表示

#### 2.3.4 データ永続化

- **ファイル形式**: JSON
- **保存場所**: `<パッケージディレクトリ>/timeline.json`
- **保存タイミング**: 明示的な保存ボタン操作

### 2.4 パッケージ管理機能

#### 2.4.1 パッケージ構造

```
PackageName/
├── .metadata/
│   ├── config.json          # チーム名、アクションリスト設定
│   └── sync.json            # 音声同期データ（自動生成）
├── timeline.json            # タイムラインデータ
└── videos/
    ├── PackageName 寄り.mp4 # タイトビュー映像
    └── PackageName 引き.mp4 # ワイドビュー映像（オプション）
```

#### 2.4.2 パッケージ作成

**4ステップウィザード**:

1. **基本情報入力**: パッケージ名、チーム1名、チーム2名
2. **保存先選択**: ディレクトリ選択
3. **映像ファイル選択**: 寄り必須、引き任意
4. **確認**: 設定内容の確認

**自動処理**:

- 映像ファイルのコピー＆リネーム
- `.metadata/config.json` の生成
- 音声同期分析の自動実行

#### 2.4.3 パッケージ読み込み

- ディレクトリ選択による一括読み込み
- ドラッグ&ドロップ対応
- チーム名、アクションリスト、タイムラインデータの自動復元

### 2.5 統計分析・可視化機能

#### 2.5.1 統計モーダル（`Cmd+Shift+A`）

**ポゼッション分析**:

- チーム別ポゼッション時間の円グラフ
- 時間フォーマット（MM:SS）

**アクション結果分析**:

- チーム別、アクション別の結果統計
- 円グラフによる視覚化

**アクション種別分析**:

- アクション種別の分布統計
- 円グラフによる視覚化

**モーメンタムチャート**:

- ポゼッション時間の棒グラフ
- チーム別色分け（赤/青）
- 結果による色分け（Try: オレンジ、Positive: 緑、Negative: 紫、Neutral: グレー）

#### 2.5.2 チャートインタラクション

- チャート要素クリックで該当映像位置にジャンプ
- スクロール対応の統計情報表示

### 2.6 ユーザーサポート機能

#### 2.6.1 オンボーディングチュートリアル

- 初回起動時に自動表示
- 4ステップのウィザード形式
- LocalStorageで完了フラグを管理
- スキップ機能

#### 2.6.2 ショートカットガイド

- コントローラー右上の「?」アイコンから表示
- カテゴリ別一覧（再生制御、音声同期、統計・分析）
- モーダル形式での表示

#### 2.6.3 エラーハンドリング

- 統一エラーステート（useVideoPlayerApp）
- エラータイプ分類: file, network, sync, playback, general
- Snackbar通知（6秒自動非表示）
- エラー種別による色分け

---

## 3. 非機能要件

### 3.1 パフォーマンス

- 映像再生のスムーズさ（60fps目標）
- タグ付け操作の即座の反応（100ms以内）
- 長時間映像ファイルの安定処理

### 3.2 ユーザビリティ

- 直感的操作（専門知識を持つユーザーが迷わず操作可能）
- キーボードショートカットによる効率的な操作
- 映像とコントロールパネルの適切な配置
- レスポンシブ対応（xs: 40vh, sm: 50vh, md: 55vh, lg: 60vh）

### 3.3 信頼性

- タイムラインデータの確実な保存
- ファイル読み込みエラー・映像再生エラーの適切な処理
- プレイヤー健全性チェック（`player.el()`, `player.error()`, ビデオ要素存在確認）
- プレイヤーエラーからの自動回復機能

### 3.4 拡張性

- 新しいスポーツ・分析項目への対応（ActionList.tsの拡張）
- 新しい映像フォーマットのサポート
- エクスポート機能（CSV、Excel）への拡張可能性

---

## 4. 技術的制約

### 4.1 プラットフォーム

- **優先対応**: macOS（dmgファイルでの配布）
- **将来対応**: Windows、Linux

### 4.2 映像フォーマット

- **対応**: MP4、MOV
- **推奨コーデック**: H.264/AVC（映像）、AAC（音声）
- **同時映像数**: 最大2つ

### 4.3 開発環境

- **Node.js**: 18.0.0以上
- **pnpm**: 9.0.0以上
- **TypeScript**: strict mode有効
- **React**: 関数コンポーネントのみ

---

## 5. アーキテクチャ設計

### 5.1 ディレクトリ構成

```
src/
├── features/              # 機能単位のモジュール
│   └── videoPlayer/
│       ├── analysis/      # 統計分析機能
│       ├── components/    # ビデオプレイヤー関連コンポーネント
│       └── hooks/         # カスタムフック
├── pages/                 # ページコンポーネント
│   └── videoPlayer/
├── hooks/                 # 共通カスタムフック
├── types/                 # 型定義
├── utils/                 # ユーティリティ
├── contexts/              # Context API
└── components/            # 共通コンポーネント

electron/
└── src/
    ├── main.ts            # メインプロセス
    ├── preload.ts         # プリロードスクリプト
    ├── menuBar.ts         # メニューバー定義
    └── shortCutKey.ts     # グローバルショートカット
```

### 5.2 設計原則

1. **関数コンポーネントのみ**: React 18の関数コンポーネント + Hooks
2. **責務分離**: View（JSX）とロジック（Hooks）を明確に分離
3. **型安全性**: TypeScript strict mode、`any`の最小化
4. **Feature-based構造**: 機能単位でコード整理、依存関係の明確化
5. **Material UI標準**: `sx`プロパティでスタイリング統一

### 5.3 命名規則

- **Reactコンポーネント**: PascalCase（ファイル・ディレクトリ含む）
- **ロジックモジュール**: camelCase
- **カスタムHook**: `useXxx.ts`形式
- **型定義**: PascalCase

### 5.4 状態管理

- **ローカル状態**: useState
- **副作用**: useEffect（完全な依存配列 + クリーンアップ必須）
- **メモ化**: useMemo、useCallback
- **Context**: NotificationContext（通知管理）

---

## 6. 実装済み改善履歴

### 6.1 パッケージ作成UX改善（2025年10月）

- 4ステップウィザード形式
- リアルタイム入力バリデーション
- 視覚的フィードバック（進捗インジケーター）

### 6.2 デザインシステム導入（2025年10月）

- 統一カラーパレット（team1: #d32f2f、team2: #1976d2）
- タイポグラフィ統一（Hiragino、Yu Gothic）
- スペーシング統一（8px基準）

### 6.3 キーボードショートカット可視化（2025年10月）

- ショートカットガイドコンポーネント
- カテゴリ別一覧表示

### 6.4 エラーハンドリング強化（2025年10月）

- 統一エラーステート
- エラータイプ分類
- Snackbar通知

### 6.5 タイムライン検索・フィルタリング強化（2025年10月）

- 複合検索機能
- リアルタイム件数表示

### 6.6 プレイヤー安定性改善（2025年10月）

- 共通シークバーNaN表示問題の修正
- 2つ目の映像消失問題の修正
- プレイヤー健全性チェック強化

---

## 7. 今後の拡張予定

### 7.1 機能拡張

- **エクスポート機能**: CSV、Excel形式でのデータエクスポート
- **プリセット管理**: よく使用するタグ付けパターンの保存・呼び出し
- **複数試合比較**: 複数パッケージ間の比較分析

### 7.2 分析機能拡張

- **時系列分析**: 試合の流れの詳細分析
- **ヒートマップ**: アクション発生位置の可視化（フィールド上）
- **高度な統計**: 勝率予測、パフォーマンス指標

### 7.3 UI/UX改善

- **テーマ機能**: ダーク/ライトテーマの切替
- **多言語対応**: 英語UI対応
- **クラウド同期**: パッケージデータのクラウドバックアップ

---

## 8. セキュリティ・プライバシー

### 8.1 データ保存

- **ローカルストレージのみ**: すべてのデータはユーザーのローカルディスクに保存
- **外部送信なし**: 映像・タイムラインデータは外部に送信されない

### 8.2 権限

- **ファイルシステム**: ユーザーが選択したディレクトリのみアクセス
- **macOS権限**: ファイルアクセス権限の適切な要求

---

## 9. テスト戦略

### 9.1 型チェック

```bash
pnpm exec tsc --noEmit          # React側
pnpm exec tsc -p electron --noEmit  # Electron側
```

### 9.2 ユニットテスト

- `pnpm test` でReact Testing Libraryによるテスト実行
- 重要なユーティリティ関数のテスト

### 9.3 手動テスト

- タイムライン永続化機能の動作確認
- 音声同期機能の精度確認
- 長時間映像での安定性確認

---

## 10. ビルド・デプロイ

### 10.1 開発環境

```bash
pnpm run electron:dev  # React + Electron同時起動
```

### 10.2 本番ビルド

```bash
pnpm run electron:start  # 最適化ビルド + 起動
```

### 10.3 配布用ビルド

```bash
pnpm run electron:build  # dmgファイル生成（dist/配下）
```

---

## 11. 依存関係管理

### 11.1 主要ライブラリ

- **React**: UI構築
- **TypeScript**: 型安全性
- **Electron**: デスクトップアプリケーション化
- **Material-UI**: UIコンポーネント
- **Video.js**: ビデオプレイヤー
- **Recharts**: グラフ可視化
- **ulid**: ユニークID生成

### 11.2 アップデート方針

- **メジャーバージョン**: 慎重に検証後アップデート
- **マイナー/パッチ**: 定期的にアップデート
- **セキュリティパッチ**: 即座にアップデート

---

## 12. ライセンス

MIT

---

## 13. 参考資料

- [プロジェクトリポジトリ](https://github.com/Kou-ISK/tag-my-video)
- [Copilot基本指示](.github/copilot-instructions.md)
- [TypeScript指示](.github/instructions/typescript.instructions.md)
- [TSX指示](.github/instructions/tsx.instructions.md)
  - 設定可能な2チーム名
  - チーム別にボタンの色分け（チーム1: 赤、チーム2: 青）

### 2.3 タイムライン管理機能

#### 2.3.1 タイムラインデータ構造

```typescript
TimelineData = {
  id: string;           // ユニークID（ULID）
  actionName: string;   // アクション名（チーム名 + アクション種別）
  startTime: number;    // 開始時刻（秒）
  endTime: number;      // 終了時刻（秒）
  actionResult: string; // アクション結果
  actionType: string;   // アクション種別
  qualifier: string;    // 追加情報・修飾子
}
```

#### 2.3.2 タイムライン表示・編集

- **テーブル表示**: 全イベントを時系列で表示
- **ソート機能**: アクション名、開始時刻、終了時刻でソート可能
- **インライン編集**:
  - アクション結果の選択（ドロップダウン）
  - アクション種別の選択（ドロップダウン）
  - 修飾子の自由入力
- **映像ジャンプ**: 開始時刻・終了時刻ボタンクリックで該当映像位置にジャンプ
- **複数選択削除**: チェックボックスによる複数イベントの一括削除

#### 2.3.3 データ永続化

- **ファイル形式**: JSON形式
- **保存場所**: パッケージディレクトリ内の`timeline.json`
- **自動保存**: 明示的な保存ボタン操作による

### 2.4 パッケージ管理機能

#### 2.4.1 パッケージ構造

```
PackageName/
├── .metadata/
│   └── config.json      # チーム名、アクションリスト設定
├── timeline.json        # タイムラインデータ
└── videos/
    ├── PackageName 寄り.mp4   # タイトビュー映像
    └── PackageName 引き.mp4   # ワイドビュー映像（オプション）
```

#### 2.4.2 パッケージ作成

- **新規パッケージ作成**:
  - パッケージ名入力
  - チーム名設定（2チーム）
  - 映像ファイル選択（寄り、引き）
  - 自動的なファイル整理・リネーム

#### 2.4.3 パッケージ読み込み

- **既存パッケージ選択**: ディレクトリ選択による一括読み込み
- **設定復元**: チーム名、アクションリスト、タイムラインデータの自動復元

### 2.5 統計分析・可視化機能

#### 2.5.1 統計表示

- **ポゼッション分析**:
  - チーム別ポゼッション時間の円グラフ表示
  - 時間フォーマット（MM:SS）での表示
- **アクション分析**:
  - チーム別、アクション別の結果統計
  - アクション種別の分布統計
  - 円グラフによる視覚化

#### 2.5.2 モメンタムチャート

- **要件**: ポゼッションの流れを視覚化
- **表示内容**:
  - ポゼッション時間の棒グラフ
  - チーム別の色分け
  - 結果による色分け（Try、Positive、Negative）

#### 2.5.3 表示制御

- **モーダル表示**: Command + Shift + A によるモーダル表示
- **スクロール対応**: 統計情報の縦スクロール表示

## 3. 非機能要件

### 3.1 パフォーマンス

- **映像再生**: スムーズな再生、同期再生の精度維持
- **レスポンス**: タグ付け操作に対する即座の反応（100ms以内）
- **大容量ファイル**: 長時間映像ファイルの安定した処理

### 3.2 ユーザビリティ

- **直感的操作**: スポーツ分析の専門知識を持つユーザーが迷わず操作できる
- **キーボードショートカット**: 映像を見ながらの効率的な操作
- **視認性**: 映像とコントロールパネルの適切な配置

### 3.3 信頼性

- **データ保護**: タイムラインデータの確実な保存
- **エラーハンドリング**: ファイル読み込みエラー、映像再生エラーの適切な処理
- **バックアップ**: 意図しないデータ削除の防止

### 3.4 拡張性

- **アクション追加**: 新しいスポーツや分析項目への対応
- **フォーマット拡張**: 新しい映像フォーマットのサポート
- **エクスポート機能**: 他システムとの連携を見据えた拡張

## 4. 制約事項

### 4.1 技術制約

- **プラットフォーム**: macOS優先（dmgファイルでの配布）
- **映像フォーマット**: MP4、MOV形式のみサポート
- **同時映像数**: 最大2つまで

### 4.2 業務制約

- **対象スポーツ**: 主にラグビー（アクションリストが特化）
- **言語**: 日本語UI
- **利用環境**: デスクトップ環境での利用を想定

## 5. 今後の拡張予定

### 5.1 機能拡張

- **映像同期機能**: 異なる開始時刻の映像の同期調整
- **エクスポート機能**: CSV、Excel形式でのデータエクスポート
- **プリセット管理**: よく使用するタグ付けパターンの保存・呼び出し

### 5.2 分析機能拡張

- **時系列分析**: 試合の流れの詳細分析
- **ヒートマップ**: アクション発生位置の可視化
- **比較分析**: 複数試合間の比較機能

### 5.3 UI/UX改善

- **レスポンシブ対応**: ウィンドウサイズに応じた最適表示 ✅ 実装済み
  - ビデオプレイヤー高さの可変対応 (xs: 40vh, sm: 50vh, md: 55vh, lg: 60vh)
  - タイムラインテーブルとコードパネルの画面サイズ別配置 (xs: 全幅, lg: 7:5分割)
  - 最小高さ・最大高さの設定による視認性確保
- **テーマ機能**: ダーク/ライトテーマの切替
- **多言語対応**: 英語UI対応

## 6. 実装済み改善 (2025年10月実施)

### 6.1 パッケージ作成UX改善

- **段階的入力フロー**: 4ステップのウィザード形式
  1. 基本情報入力 (パッケージ名、チーム名)
  2. 保存先選択
  3. 映像ファイル選択 (寄り必須、引き任意)
  4. 作成内容確認
- **入力バリデーション**: リアルタイムエラー表示
- **視覚的フィードバック**: 選択済みファイルの明確な表示、進捗インジケーター
- **操作性向上**: 前後のステップ移動、キャンセル機能

### 6.2 デザインシステム導入

- **統一カラーパレット**:
  - team1: 赤系統 (#d32f2f)
  - team2: 青系統 (#1976d2)
  - momentum: Try (#ff5722), Positive (#4caf50), Negative (#9c27b0), Neutral (#757575)
- **タイポグラフィ**: Hiragino, Yu Gothic対応
- **スペーシング**: 8px基準の統一
- **角丸**: デフォルト8pxの統一感

### 6.3 キーボードショートカット可視化

- **ショートカットガイドコンポーネント**:
  - ビデオコントローラーにアイコンボタン配置
  - モーダルでカテゴリ別一覧表示
  - 再生制御、音声同期、統計・分析の3カテゴリ
- **ユーザビリティ向上**: 新規ユーザーの機能発見を支援

### 6.4 エラーハンドリング強化

- **統一エラーステート**: useVideoPlayerAppフックで一元管理
- **エラータイプ分類**: file, network, sync, playback, general
- **Snackbar通知**: 6秒自動非表示、エラー種別による色分け
- **ユーザーフレンドリー**: 分かりやすいエラーメッセージ

### 6.5 タイムライン検索・フィルタリング強化

- **複合検索機能**:
  - テキスト検索: アクション名、修飾子、結果、種別の横断検索
  - チーム別フィルタ: ドロップダウンで特定チームのみ表示
  - アクション種別フィルタ: 種別による絞り込み
- **リアルタイム件数表示**: フィルタ適用後の件数と全件数の表示
- **UIの洗練**: Select, TextField, InputAdornmentの組み合わせ
