# Technical Instructions - Tag My Video

## アーキテクチャ概要

このプロジェクトは**Electron + React + TypeScript**を採用したデスクトップアプリケーションです。

### 主要な技術スタック

- **フロントエンド**: React 18.2.0 + TypeScript 4.9.5
- **デスクトップフレームワーク**: Electron 25.4.0
- **UIライブラリ**: Material-UI v5
- **映像再生**: Video.js 8.3.0
- **チャート表示**: Recharts 2.8.0
- **ビルドツール**: React Scripts + Electron Builder
- **パッケージ管理**: Yarn

## プロジェクト構造

```
tag-my-video/
├── electron/                # Electronメインプロセス
│   ├── src/
│   │   ├── main.ts         # メインプロセスのエントリーポイント
│   │   ├── preload.ts      # プリロードスクリプト（IPC通信）
│   │   ├── utils.ts        # ファイルI/O、パッケージ管理
│   │   ├── shortCutKey.ts  # キーボードショートカット
│   │   └── menuBar.ts      # アプリケーションメニュー
│   └── tsconfig.json       # Electron用TypeScript設定
├── src/                     # Reactアプリケーション
│   ├── components/         # UIコンポーネント
│   │   └── VideoPlayer/    # 映像プレイヤー関連コンポーネント
│   ├── hooks/              # カスタムフック
│   ├── pages/              # ページコンポーネント
│   └── types/              # TypeScript型定義
├── public/                 # 静的ファイル
├── build/                  # ビルド成果物
└── dist/                   # パッケージング成果物
```

## 開発ガイドライン

### 1. コード品質

#### TypeScript使用規則

- **必須**: 全てのファイルでTypeScriptを使用する
- **型定義**: `any`型の使用を避け、適切な型定義を行う
- **インターface**: 再利用可能な型は`src/types/`に定義する

#### ESLint・Prettier設定

- **自動フォーマット**: コミット前に`npm run fix`を実行
- **CI/CD**: Pull Request時に自動フォーマット実行
- **設定ファイル**: `.eslintrc`, `.prettierrc`で統一

### 2. コンポーネント設計

#### React Hooks使用方針

- **状態管理**: `useState`を基本とし、複雑な状態は`useReducer`を検討
- **カスタムフック**: ビジネスロジックは`hooks/`ディレクトリに分離
- **副作用**: `useEffect`の依存配列を適切に設定

#### コンポーネント分割指針

- **単一責任**: 一つのコンポーネントは一つの責任を持つ
- **プロップス**: 型安全なプロップス定義を必須とする
- **ディレクトリ構造**: 機能別にコンポーネントをグループ化

### 3. Electron特有の考慮事項

#### プロセス間通信（IPC）

- **セキュリティ**: `contextIsolation: true`を維持
- **型安全性**: `renderer.d.ts`でIPC APIの型定義を管理
- **プリロード**: レンダラープロセスからのNodeJS APIアクセスは`preload.ts`経由

#### ファイルシステム操作

- **パス処理**: Electronの`path`モジュールを使用
- **ファイルダイアログ**: `dialog`モジュールを使用した統一的なファイル選択
- **非同期処理**: ファイルI/Oは`async/await`パターンを使用

### 4. 映像処理

#### Video.js統合

- **プレイヤー管理**: useEffectでのプレイヤー初期化と破棄
- **同期再生**: 複数プレイヤーの時刻同期機能を維持
- **メモリ管理**: プレイヤーインスタンスの適切な破棄

#### 音声同期機能

- **音声波形分析**: Web Audio APIを使用したクロスコリレーション分析
- **自動同期**: パッケージ作成時の自動音声同期オフセット検出
- **同期精度**: 信頼度スコアによる同期品質の可視化
- **共通シークバー**: 複数映像の統一された時間軸制御

#### パフォーマンス考慮

- **大容量ファイル**: プログレッシブダウンロードによる再生開始
- **メモリ使用量**: 不要な映像データのガベージコレクション促進
- **音声処理**: AudioContextの適切な管理とクリーンアップ

### 5. データ管理

#### タイムラインデータ

- **型安全性**: `TimelineData`型を厳密に適用
- **ID管理**: ULIDを使用したユニークID生成
- **永続化**: JSONファイルでの保存と読み込み

#### パッケージ管理

- **ファイル構造**: 決められたディレクトリ構造を維持
- **メタデータ**: `MetaData`型による設定情報管理
- **バックアップ**: 重要なデータの複製と復旧機能

### 6. UI/UX設計

#### Material-UI使用方針

- **テーマ**: 一貫したデザインシステムの適用
- **レスポンシブ**: `sx`プロップによるレスポンシブデザイン
- **アクセシビリティ**: ARIA属性の適切な設定

#### キーボード操作

- **ショートカット**: `electron-localshortcut`による統一的な実装
- **フォーカス管理**: Tab順序の論理的な設定
- **操作性**: 映像視聴中の効率的な操作を重視

### 7. ビルド・デプロイ

#### 開発環境

```bash
# 開発サーバー起動
yarn electron:dev

# 本番ビルド
yarn electron:build
```

#### パッケージング

- **ターゲット**: macOS (dmg)を優先
- **設定**: `electron-builder.json`による設定管理
- **アイコン**: `public/icon.png`を使用

#### リリース管理

- **バージョニング**: `package.json`のバージョンに従う
- **変更履歴**: 機能追加・修正内容の適切な記録
- **テスト**: リリース前の動作確認必須

### 8. 禁止事項・注意点

#### セキュリティ

- **nodeIntegration**: `false`を維持（セキュリティリスク回避）
- **外部URL**: 信頼できないURLの読み込み禁止
- **ファイルアクセス**: サンドボックス外でのファイル操作制限

#### パフォーマンス

- **メモリリーク**: useEffectのクリーンアップ関数を必ず実装
- **不要なレンダリング**: React.memo, useMemo, useCallbackの適切な使用
- **大容量データ**: 一度に大量のデータを処理しない

### 9. コードレビュー要点

#### 必須チェック項目

- [ ] TypeScript型定義の適切性
- [ ] プロップスの型安全性
- [ ] useEffectの依存配列とクリーンアップ
- [ ] Electronセキュリティ設定の維持
- [ ] ファイルパスの適切な処理
- [ ] エラーハンドリングの実装

#### パフォーマンスチェック

- [ ] 不要な再レンダリングの防止
- [ ] メモリリークの可能性
- [ ] ファイルI/Oの効率性
- [ ] 映像再生のスムーズさ

### 10. トラブルシューティング

#### よくある問題

1. **映像が再生されない**: ファイルパスの確認、コーデック対応確認
2. **同期がずれる**: プレイヤーの初期化タイミング調整
3. **ビルドエラー**: TypeScript型エラー、依存関係の確認
4. **パッケージング失敗**: electron-builderの設定確認

#### デバッグ方法

- **開発者ツール**: `toggleDevTools`メニューから開発者ツール使用
- **ログ出力**: `console.log`による詳細ログ出力
- **プロファイリング**: Reactプロファイラーによるパフォーマンス分析

## 今後の技術的改善点

### 短期的改善

- **テストコード**: Jest + Testing Libraryによる自動テスト実装
- **エラー境界**: React Error Boundaryによるエラーハンドリング改善
- **ログシステム**: 統一的なログ出力システムの導入

### 中長期的改善

- **状態管理**: ReduxやZustandの導入検討
- **パフォーマンス**: Web Workersによる重い処理の並列化
- **拡張性**: プラグインシステムの導入

## 新機能実装ガイドライン

### 音声同期機能

#### 実装アーキテクチャ

- **AudioSyncAnalyzer**: Web Audio APIを使用した音声波形分析クラス
- **VideoSyncData**: 同期データを管理する型定義
- **SyncedVideoPlayer**: 同期オフセットを考慮した映像プレイヤー
- **共通シークバー**: 複数映像の統一制御機能

#### 実装時の注意点

- **AudioContext管理**: メモリリークを防ぐため適切にdispose()を呼ぶ
- **非同期処理**: 音声分析は時間がかかるためプログレス表示必須
- **エラーハンドリング**: 同期失敗時のフォールバック処理を実装
- **型安全性**: VideoSyncData型を厳密に適用

#### テスト方法

1. 2つの映像ファイルでパッケージ作成
2. 音声同期分析の実行確認
3. 共通シークバーでの同期再生確認
4. 同期情報の表示確認

### 今後の拡張可能性

- **手動同期調整**: ユーザーによる手動オフセット調整機能
- **高度な分析**: MFCC（メル周波数ケプストラム係数）を使用した高精度同期
- **リアルタイム同期**: 再生中の動的同期調整機能
- **音声可視化**: 波形表示による視覚的同期確認
