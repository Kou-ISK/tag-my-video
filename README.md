# Tag My Video

スポーツビデオ分析のための映像タグ付けElectronアプリケーション

## 概要

Tag My Videoは、スポーツ（特にラグビー）の映像分析を効率化するためのデスクトップアプリケーションです。複数の映像を同期再生しながら、プレーイベントをリアルタイムでタグ付けし、統計分析やグラフ化を行えます。

### 主な機能

- **デュアル映像同期再生**: 2つの映像（寄り/引き）を音声波形で自動同期
- **リアルタイムタグ付け**: キーボード・マウス操作で映像にイベントを記録
- **統計分析**: ポゼッション、アクション結果、モーメンタムの自動可視化
- **タイムライン管理**: イベントの編集・検索・削除機能
- **パッケージ管理**: 試合ごとのデータを1つのフォルダで管理

---

## 技術スタック

- **フロントエンド**: React 18.3.1 + TypeScript 5.9.3
- **デスクトップ**: Electron 31.7.7
- **UI**: Material-UI 5.18.0
- **ビデオ**: Video.js 8.23.4
- **パッケージマネージャー**: pnpm 9.1.0+
- **ビルドツール**: react-scripts 5.0.1

---

## インストール

### macOS (Homebrew) - 推奨

```bash
# Coming soon - Homebrew Caskからインストール予定
brew install --cask tag-my-video
```

### 手動インストール

1. [Releases](https://github.com/Kou-ISK/tag-my-video/releases)から最新版をダウンロード
2. macOS: `Tag-My-Video-x.x.x.dmg` をダウンロードしてインストール
3. Windows: `Tag-My-Video-Setup-x.x.x.exe` をダウンロードして実行
4. Linux: `Tag-My-Video-x.x.x.AppImage` をダウンロードして実行権限を付与

---

## 開発者向けセットアップ

### 前提条件

- Node.js 18.0.0 以上
- pnpm 9.0.0 以上

### インストール

```bash
# pnpmのインストール（未インストールの場合）
npm install -g pnpm

# 依存関係のインストール
pnpm install
```

---

## 起動方法

### 開発モード（推奨）

ReactとElectronを同時に起動します：

```bash
pnpm run electron:dev
```

### 本番ビルド＋起動

最適化されたビルドを作成してElectronを起動します：

```bash
pnpm run electron:start
```

### 配布用アプリケーションのビルド

dmgファイルを生成します（`dist/`配下に出力）：

```bash
pnpm run electron:build
```

### その他のコマンド

```bash
# 型チェック（React側）
pnpm exec tsc --noEmit

# 型チェック（Electron側）
pnpm exec tsc -p electron --noEmit

# コードフォーマット
pnpm run format

# Lint + Format
pnpm run fix
```

---

## 使い方

### 1. 初回起動時

アプリを初めて起動すると、**オンボーディングチュートリアル**が自動表示されます。主要機能の使い方を段階的に学べます。

### 2. パッケージ作成（新規試合の分析）

1. **「新規パッケージ作成」ボタン**をクリック
2. **4ステップウィザード**で以下を入力：
   - **Step 1**: パッケージ名、チーム1名、チーム2名
   - **Step 2**: 保存先ディレクトリの選択
   - **Step 3**: 映像ファイルの選択（寄り必須、引き任意）
   - **Step 4**: 設定内容の確認
3. **「作成」ボタン**で完了
   - 映像ファイルは自動的にパッケージ内にコピー＆リネーム
   - 音声同期分析が自動実行されます

### 3. パッケージを開く（既存試合の続き）

- **「パッケージを開く」ボタン**をクリックし、パッケージフォルダを選択
- または**ドラッグ&ドロップ**でパッケージフォルダを開く

### 4. 映像の同期（複数映像がある場合）

#### 自動同期（推奨）

パッケージ作成時に自動実行されますが、再実行も可能です：

- **メニューバー**: 映像 → 音声同期を再実行（`Cmd+Shift+S`）
- **UIボタン**: コントローラーの「同期再実行」ボタン

#### 手動調整

- **メニューバー**: 映像 → 同期オフセット調整（`Cmd+Shift+O`）
- **UIボタン**: コントローラーの「オフセット調整」ボタン

#### 同期リセット

- **メニューバー**: 映像 → 同期をリセット（`Cmd+Shift+R`）
- **UIボタン**: コントローラーの「同期リセット」ボタン

### 5. イベントのタグ付け

1. **映像を再生**（`↑`キーまたは再生ボタン）
2. **アクションボタンをクリック**（1回目）→ イベント開始時刻を記録
3. **再度同じボタンをクリック**（2回目）→ イベント終了時刻を記録
4. タイムラインテーブルに自動追加されます

### 6. タイムラインの編集

- **ドロップダウン**: アクション結果・種別の変更
- **テキスト入力**: 修飾子（Qualifier）の自由記述
- **時刻ボタン**: クリックで該当映像位置にジャンプ
- **チェックボックス + 削除ボタン**: 複数イベントの一括削除
- **検索・フィルタ**: テキスト検索、チーム別フィルタ、アクション種別フィルタ

### 7. 統計の表示

- **メニューバー**: 分析 → 統計を表示（`Cmd+Shift+A`）
- **モーダル内タブ**:
  - **ポゼッション**: チーム別ポゼッション時間の円グラフ
  - **アクション結果**: アクション別の結果統計（円グラフ）
  - **アクション種別**: アクション種別の分布（円グラフ）
  - **モーメンタム**: 時系列のポゼッション流れ（棒グラフ）

### 8. データの保存

- **「保存」ボタン**をクリック
- タイムラインデータが `timeline.json` に保存されます

---

## キーボードショートカット

### 再生制御

| キー         | 機能        |
| ------------ | ----------- |
| `↑`          | 再生/停止   |
| `→`          | 0.5倍速再生 |
| `Shift + →`  | 2倍速再生   |
| `Cmd + →`    | 4倍速再生   |
| `Option + →` | 6倍速再生   |
| `←`          | 5秒戻し     |
| `Shift + ←`  | 10秒戻し    |

### 音声同期

| キー              | 機能               |
| ----------------- | ------------------ |
| `Cmd + Shift + S` | 音声同期を再実行   |
| `Cmd + Shift + R` | 同期をリセット     |
| `Cmd + Shift + O` | 同期オフセット調整 |

### 統計・分析

| キー              | 機能               |
| ----------------- | ------------------ |
| `Cmd + Shift + A` | 統計モーダルを表示 |

**ヒント**: コントローラー右上の「?」アイコンから、ショートカットガイドをいつでも確認できます

---

## 詳細機能

### 音声同期機能

複数の映像ファイルの音声波形を分析して自動的に同期を取る機能です。

#### 仕組み

1. **音声データ抽出**: 各映像から音声トラックを取得
2. **波形分析**: FFT（高速フーリエ変換）で特徴量を計算
3. **相互相関**: 波形パターンのマッチングで時間オフセットを検出
4. **信頼度計算**: 同期精度をスコア化（0-100%）
5. **自動適用**: 検出されたオフセットを映像再生に反映

#### 表示される情報

- **同期オフセット**: 2つの映像の時間差（秒）
- **信頼度**: 同期の正確性（0-100%）
  - 80%以上: 高精度（緑色）
  - 80%未満: 要確認（黄色）
- **分析状態**: 同期分析が完了しているかどうか

#### ファイル名ベースのヒント検出

ファイル名に「寄り」「引き」「tight」「wide」などのキーワードが含まれていると、カメラ種別を自動判定し、同期精度が向上します。

### パッケージ構造

各パッケージは以下の構造で保存されます：

```
PackageName/
├── .metadata/
│   ├── config.json          # チーム名、アクションリスト設定
│   └── sync.json            # 音声同期データ（自動生成）
├── timeline.json            # タイムラインデータ
└── videos/
    ├── PackageName 寄り.mp4 # タイトビュー映像
    └── PackageName 引き.mp4 # ワイドビュー映像（オプション）
```

### タイムラインデータ構造

```typescript
TimelineData = {
  id: string;           // ユニークID（ULID形式）
  actionName: string;   // アクション名（チーム名 + アクション種別）
  startTime: number;    // 開始時刻（秒）
  endTime: number;      // 終了時刻（秒）
  actionResult: string; // アクション結果
  actionType: string;   // アクション種別
  qualifier: string;    // 追加情報・修飾子
}
```

### 対応アクション（ラグビー）

- **ポゼッション**: Try, Drop Goal, Kick Out of Play, Kick Error, Pen Won, Scrum, Turnover など
- **スクラム**: Won Outright, Won FK, Won PK, Lost Outright, Reset など
- **ラインアウト**: Won, Won & Maul, Won Tap, Lost Throwing Error など
- **キック**: Touch(Bounce), Touch(Full), Error, Caught Full, In Goal など
- **PK**: Not Releasing, Not Rolling Away, Off Feet at Ruck, Offside など
- **トライ**: Conversion Success, Conversion Missed（BK/FW別）
- **ショット**: Success, Missed
- **チェック**: Good, Bad（Offence/Defence別）

詳細は `src/ActionList.ts` を参照してください。

---

## アーキテクチャ

### ディレクトリ構成

```
src/
├── features/              # 機能単位のモジュール
│   └── videoPlayer/
│       ├── analysis/      # 統計分析機能
│       │   ├── hooks/
│       │   └── utils/
│       ├── components/    # ビデオプレイヤー関連コンポーネント
│       │   ├── Analytics/ # 統計・グラフ表示
│       │   ├── Controls/  # 再生制御UI
│       │   ├── Player/    # プレイヤー本体
│       │   ├── Setup/     # パッケージ作成・選択
│       │   └── Timeline/  # タイムライン表示・編集
│       └── hooks/         # カスタムフック
├── pages/                 # ページコンポーネント
│   ├── VideoPlayerApp.tsx
│   └── videoPlayer/
│       ├── components/    # ページ固有UI
│       └── hooks/         # ページ固有ロジック
├── hooks/                 # 共通カスタムフック
├── types/                 # 型定義
├── utils/                 # ユーティリティ
├── contexts/              # Context API
└── components/            # 共通コンポーネント

electron/
└── src/
    ├── main.ts            # メインプロセス
    ├── preload.ts         # プリロードスクリプト
    ├── menuBar.ts         # メニューバー定義
    └── shortCutKey.ts     # グローバルショートカット
```

### 設計原則

- **関数コンポーネントのみ**: React 18の関数コンポーネント + Hooksを使用
- **責務分離**: View（JSX）とロジック（Hooks）を明確に分離
- **型安全性**: TypeScript strict mode有効、`any`の使用を最小化
- **Feature-based構造**: 機能単位でコードを整理し、依存関係を明確化
- **Material UI標準**: `sx`プロパティでスタイリング統一

---

## トラブルシューティング

### 映像が再生されない

1. **対応フォーマット確認**: MP4、MOV形式のみサポート
2. **コーデック確認**: H.264/AVC、AAC音声を推奨
3. **ファイルパス確認**: 日本語を含むパスでも動作しますが、半角英数字推奨
4. **権限確認**: macOSの場合、システム環境設定でファイルアクセス権限を確認

### 同期がうまくいかない

1. **音声トラック確認**: 両方の映像に音声が含まれていることを確認
2. **ファイル名ヒント**: ファイル名に「寄り」「引き」を含めると精度向上
3. **手動調整**: 自動同期が失敗した場合、手動オフセット調整を試す
4. **再分析**: 「同期をリセット」→「音声同期を再実行」で再試行

### タイムラインが保存されない

1. **書き込み権限確認**: パッケージディレクトリの書き込み権限を確認
2. **保存ボタン確認**: 明示的に「保存」ボタンをクリックする必要があります
3. **ディスク容量確認**: 十分な空き容量があることを確認

### アプリが起動しない

1. **Node.jsバージョン確認**: `node -v`で18.0.0以上であることを確認
2. **pnpmインストール確認**: `pnpm -v`でインストールされていることを確認
3. **依存関係再インストール**: `rm -rf node_modules && pnpm install`
4. **キャッシュクリア**: `pnpm store prune`

---

## 開発者向け情報

### コーディング規約

詳細は `.github/copilot-instructions.md` を参照してください。

- すべて TypeScript で実装し、`any` の使用は避ける
- React 18 の関数コンポーネントのみ使用
- Material UI の `sx` プロパティでスタイリング
- `useEffect` には完全な依存配列とクリーンアップを必ず定義
- コンポーネント名・ディレクトリは PascalCase
- ロジックモジュール・ファイル名は camelCase
- カスタム Hook は `useXxx.ts` 形式

### テスト実行

```bash
# ユニットテスト
pnpm test

# 型チェック（全体）
pnpm exec tsc --noEmit
pnpm exec tsc -p electron --noEmit
```

### デバッグ

- **React DevTools**: 開発モードで自動的に有効
- **Electron DevTools**: `Cmd+Option+I`で開く
- **ログ出力**: `console.log`はElectronコンソールとブラウザコンソール両方に出力

---

## ライセンス

MIT

---

## リポジトリ

https://github.com/Kou-ISK/tag-my-video
