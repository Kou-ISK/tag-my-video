# このアプリについて

### 概要

- スポーツのビデオ分析での利用を想定
- ボタン操作を通じて映像にイベントをタグ付けするアプリ
- 2つの映像ファイルを同時に再生することが可能
  - ボタン1回目押下時、2回目押下時の映像の秒数を取得し、タイムライン配列に格納する。
  - 保存ボタンを押すことでタイムラインはJSONファイルに保存される

### ホットキー

- 上キー: 再生/停止
- 右キー: 0.5倍速再生
- ⇧ + 右キー: 2倍速再生
- ⌘ + 右キー: 4倍速再生
- ⌥ + 右キー: 6倍速再生
- 左キー: 5秒戻し
- ⇧ + 左キー: 10秒戻し
- ⌘ + ⇧ + A: グラフを表示

## ターミナ操作手順

### ターミナルから起動する方法

以下コマンドをターミナルで実行

```zsh
yarn init
yarn electron:start
```

### アプリを配布可能な形式にビルドする手順

以下コマンドを実行することでdist配下にdmgファイルが配置される。

```zsh
yarn electron:build
```

## 新機能：音声同期機能（改善版）

### 概要

複数の映像ファイルがある場合、音の波形を分析して自動的に同期を取る機能が追加されました。

### 使用方法（改善版）

1. **新規パッケージ作成時**

   - パッケージ名とチーム名を入力
   - 寄り（タイト）映像を選択
   - ワイド映像を選択（音声同期分析が自動実行されます）

2. **同期分析**

   - 分析中は「音声同期を分析中...」のメッセージが表示されます
   - 分析完了後、同期オフセットと信頼度が表示されます
   - **映像プレイヤーは自動的に新しい同期設定を適用します**

3. **同期再実行・調整**

   - **メニューバー**: 映像 → 音声同期を再実行（Cmd+Shift+S）
   - **メニューバー**: 映像 → 同期をリセット（Cmd+Shift+R）
   - **メニューバー**: 映像 → 同期オフセット調整（Cmd+Shift+O）
   - **UIボタン**: コントローラーの「同期再実行」「同期リセット」「オフセット調整」ボタン
   - **即座に反映**: すべての同期操作は映像に即座に反映されます

4. **リアルタイム同期再生**
   - 共通シークバーで2つの映像を同時制御できます
   - 同期情報（オフセット・信頼度）がシークバー下に表示されます
   - プレイヤーは同期オフセットをリアルタイムで維持します

### 表示される情報

- **同期オフセット**: 2つの映像の時間差（秒）
- **信頼度**: 同期の正確性（0-100%）
- **分析状態**: 同期分析が完了しているかどうか
- **同期品質**: 高精度（信頼度80%以上）または要確認（80%未満）

## 修正されたバグ（v2.2）

### 2つ目の映像が表示されなくなる問題

**問題**: シーク操作中に2つ目の映像が表示されなくなる、または完全に消失する問題が発生していました。

**原因**:

- **プレイヤーの頻繁な再初期化**: 同期処理時の不適切な強制更新によるコンポーネント再マウント
- **不安定なVideo.js状態管理**: プレイヤーの健全性チェック不足による操作エラー
- **過度なシーク処理**: 小さな時間差でも頻繁にシークが実行され、プレイヤーが不安定化
- **エラーハンドリング不足**: プレイヤーエラー時の適切な回復処理の欠如

**修正内容**:

**SyncedVideoPlayer.tsx**:

- **強制更新の最小化**: 初回同期時のみ強制更新を実行し、頻繁な再マウントを防止
- **プレイヤー健全性チェック強化**: `player.el()`、`player.error()`、ビデオ要素の存在確認
- **シーク閾値の調整**: 2.0秒以上の差がある場合のみシーク実行（安定性向上）
- **詳細ログ追加**: プレイヤー状態の詳細な監視とデバッグ情報出力
- **非同期シーク処理**: `requestAnimationFrame`による安全なシーク実行
- **待機時間最適化**: プレイヤー準備待機時間を500msに延長

**SingleVideoPlayer.tsx**:

- **プレイヤー初期化の改善**: より安全なVideo.jsオプション設定とエラーハンドリング
- **破棄処理の強化**: `isDisposed()`チェックによる二重破棄防止
- **メタデータ処理の改善**: `loadedmetadata`イベントの適切な処理とタイムアウト設定
- **状態確認の厳密化**: `readyState`、`error()`、`paused()`の安全な呼び出し
- **シーク処理の最適化**: 1.5秒以上の差がある場合のみシーク実行
- **ソース変更の安全性**: プレイヤー状態確認後のソース変更実行
- **再生制御の改善**: Promiseベースの再生制御とエラーキャッチ

**結果**:

- 2つ目の映像が消失する問題が完全に解決
- シーク操作時の安定性が大幅に向上
- プレイヤーエラーからの自動回復機能が追加
- デバッグ情報の充実による問題の早期発見が可能

## 修正されたバグ（v2.1）

### 共通シークバーのNaN表示問題

**問題**: 共通シークバーで「NaN」が表示され、操作ができない問題が発生していました。

**原因**:

- Video.jsプレイヤーの初期化が完了する前に`currentTime()`や`duration()`を呼び出し
- 映像ファイルのメタデータ読み込み前での値取得
- NaNや無効な値に対する不十分なチェック

**修正内容**:

- **安全な初期化**: Video.jsの`ready()`と`loadedmetadata`イベントを適切に活用
- **型安全性強化**: 厳密な型チェック（`typeof`, `!isNaN`, 範囲検証）を実装
- **フォールバック機能**: 取得失敗時の自動再試行とデフォルト値設定
- **多層防護**: 入力→表示→操作の各段階での値検証
- **デバッグ強化**: 問題追跡のための詳細なログ出力

**結果**: 共通シークバーが常に正常な数値で動作し、安定したUI操作が可能になりました。
